function registerEvents(e) { var i = $("[id$=hdnCurrentUserName]").val(), t = parseInt($("[id$=hdnCurrentUserID]").val()); e.server.connect(i, t) } function registerClientMethods(e) { e.client.onConnected = function (t, n, s, a, o) { for ($("#hdId").val(t), $("#hdUserName").val(n), i = 0; i < s.length; i++) AddUser(e, s[i].UserID, s[i].UserName, o); for (i = 0; i < a.length; i++) AddMessage(a[i].UserName, a[i].Message) } } function CheckHiddenWindow() { var e; return "undefined" != typeof document.hidden ? e = "visibilityState" : "undefined" != typeof document.mozHidden ? e = "mozVisibilityState" : "undefined" != typeof document.msHidden ? e = "msVisibilityState" : "undefined" != typeof document.webkitHidden && (e = "webkitVisibilityState"), "hidden" == document[e] ? !0 : !1 } function AddUser(e, i, t, n) { var s = parseInt($("[id$=hdnCurrentUserID]").val()), a = $("#hdId").val(), o = ""; "" == a && n == s && ($("#hdId").val(i), a = i, $("#hdUserName").val(t)), a != i ? 0 == $("#" + i).length && (o = $('<a id="' + i + '" class="col-sm-12 bg-success" > <i class="fa fa-user"></i> ' + t + "<a>"), $(o).dblclick(function () { var i = $(this).attr("id"); a != i && OpenPrivateChatWindow(e, i, t) })) : 0 == $("#curruser_" + i).length && (o = $('<div id="curruser_' + i + '" class="col-sm-12 bg-info"  ><i class="fa fa-user"></i> ' + t + "<div>")), $("#chat_box").append(o) } function OpenPrivateChatWindow(e, i, t) { var n = "private_" + i; $("#" + n).length > 0 || createPrivateChatWindow(e, i, n, t, t) } function createPrivateChatWindow(e, i, t, n, s) { $("#chat_div").append('<div id="' + t + '"></div>'), showList.push(t), $("#" + t).chatbox({ id: t, title: s, user: n, offset: getNextOffset(), width: 200, messageSent: function (t, n, s) { e.server.sendPrivateMessage(i, s), TypingFlag = !0 }, boxClosed: function (e) { $("#" + e).remove(); var i = showList.indexOf(e); if (-1 != i) { showList.splice(i, 1), diff = config.width + config.gap; for (var t = i; t < showList.length; t++) offset = $("#" + showList[t]).chatbox("option", "offset"), $("#" + showList[t]).chatbox("option", "offset", offset - diff) } } }), $("#" + t).siblings().css("position", "relative"), $("#" + t).siblings().append('<div id="typing_' + i + '" style="width:20px; height:20px; display:none; position:absolute; right:14px; top:8px"><img height="20" src="' + srp + 'images/pencil.gif" /></div>'), $("#" + t).siblings().find("textarea").on("input", function (t) { 1 == TypingFlag && e.server.sendUserTypingRequest(i), TypingFlag = !1 }); var a = parseInt($("[id$=hdnCurrentUserID]").val()), o = i; e.server.requestLastMessage(a, o) } function ResetTypingFlag() { TypingFlag = !0 } function AddMessage(e, i) { } var chatHub = $.connection.chatHub; $(document).ready(function () { $('<audio id="chatAudio"><source src="' + srp + 'images/notify.ogg" type="audio/ogg"><source src="' + srp + 'images/notify.mp3" type="audio/mpeg"><source src="' + srp + 'images/notify.wav" type="audio/wav"></audio>').appendTo("body"); var e = $.connection.chatHub; registerClientMethods(e), $.connection.hub.start().done(function () { registerEvents(e) }), $("#chat_min_button").click(function () { '<i class="fa fa-minus-square"></i>' == $(this).html() ? $(this).html('<i class="fa fa-plus-square"></i>') : $(this).html('<i class="fa fa-minus-square"></i>'), $("#chat_box").slideToggle() }), setInterval(ResetTypingFlag, 6e3) }), chatHub.client.onNewUserConnected = function (e, i, t) { AddUser(chatHub, e, i, t) }, chatHub.client.onUserDisconnected = function (e, i) { $("#" + e).remove() }, chatHub.client.messageReceived = function (e, i) { AddMessage(e, i) }, chatHub.client.sendPrivateMessage = function (e, i, t, n) { var s = "private_" + e; if (0 == $("#" + s).length) createPrivateChatWindow(chatHub, e, s, i, t), $("#chatAudio")[0].play(); else { var a = CheckHiddenWindow(); "none" == $("#" + s).parent().css("display") && ($("#" + s).parent().parent().effect("shake", { times: 2 }, 1e3), a = !0), 1 == a && $("#chatAudio")[0].play() } $("#" + s).chatbox("option", "boxManager").addMsg(i, n), $("#typing_" + e).hide() }, chatHub.client.GetLastMessages = function (e, t) { var n = "private_" + e, s = ""; for (i = 0; i < t.length; i++) s += '<div style="display: block; max-width: 200px;" class="ui-chatbox-msg">', i == t.length - 1 ? $("#" + n).children().last().html() != "<b>" + t[i].FromUserName + ": </b><span>" + t[i].Message + "</span>" && (s += "<b>" + t[i].FromUserName + ": </b><span>" + t[i].Message + "</span>") : s += "<b>" + t[i].FromUserName + ": </b><span>" + t[i].Message + "</span>", s += "</div>"; $("#" + n).prepend(s) }, chatHub.client.ReceiveTypingRequest = function (e) { var i = "private_" + e; $("#" + i).length > 0 && (jQuery("#typing_" + e).show(), jQuery("#typing_" + e).delay(6e3).fadeOut("slow")) }; var showList = new Array, config = { width: 200, gap: 20, maxBoxes: 5 }, getNextOffset = function () { return (config.width + config.gap) * showList.length }, TypingFlag = !0;