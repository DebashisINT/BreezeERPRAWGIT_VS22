@using System.Web.UI.WebControls
@using DevExpress.Web.Mvc
@using DevExpress.Web
@model Manufacturing.Models.ViewModel.WorkOrderViewModel

@{
    ViewBag.Title = "Work Order(Production)";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/assests/css/SearchPopup.css" rel="stylesheet" />
<script src="~/Scripts/SearchPopup.js"></script>
<script>
    function btnPartNoList_Click(s, e) {
        PartNolist('', 'PartNo');
        setTimeout(function () { $("#txtPartNoCode").focus(); }, 500);
        $('#PartNolistModel').modal('show');
    }
    function btnPartNo_KeyDown(s, e) {
        if (e.htmlEvent.key == "Enter") {
            s.OnButtonClick(0);
        }
        else if (e.code == "ArrowDown") {
            if ($("input[PartNoIndex=0]"))
                $("input[PartNoIndex=0]").focus();
        }
    }
    function PartNolist(SearchKey, type) {
        finishedproductlist = 1;
        var OtherDetails = {}
        OtherDetails.SearchKey = SearchKey;
        OtherDetails.Action = type;
        var HeaderCaption = [];
        HeaderCaption.push("Product Code");
        callonServerScroll("../Models/pManufacturing_WebServiceList.asmx/GetPartNoDetailsList", OtherDetails, "PartNoTable", HeaderCaption, "PartNoIndex", "SetPartNo");
    }
    function SetPartNo(Id, Name, e) {
        finishedproductlist = 0;
        var ProductID = Id;
        var ProductCode = Name;
        if (ProductID != "") {
            var data = ProductID.split('|');
            ProductID = data[0];
            var DesignNo = data[2];
            var RevisionNo = data[3];
            $('#PartNolistModel').modal('hide');
            btnPartNo.SetText(ProductCode);
            $('#hdnPartNo').val(ProductID);
            $('#DesignNo').val(DesignNo);
            $('#ItemRevNo').val(RevisionNo);
           
        }
    }
    function SetFocusItemRevNo() {
        $('#ItemRevNo').focus();
    }
    function PartNoListkeydown(e) {
        if (e.code == "Enter" || e.code == "NumpadEnter") {
            if ($("#txtPartNoCode").val() != '') {
                PartNolist($("#txtPartNoCode").val(), 'PartNo');
            }
        }
        else if (e.code == "ArrowDown") {
            if ($("input[PartNoIndex=0]"))
                $("input[PartNoIndex=0]").focus();
        }
    }
    function ValueSelected(e, indexName) {
        if (e.code == "Enter") {
            var Id = e.target.parentElement.parentElement.cells[0].innerText;
            var name = e.target.parentElement.parentElement.cells[1].children[0].value;
            if (Id) {
                if (indexName == "PartNoIndex") {
                    SetPartNo(Id, name, null);
                }                
            }
        }
        else if (e.code == "ArrowDown") {
            thisindex = parseFloat(e.target.getAttribute(indexName));
            thisindex++;
            if (thisindex < 10)
                $("input[" + indexName + "=" + thisindex + "]").focus();
        }
        else if (e.code == "ArrowUp") {
            thisindex = parseFloat(e.target.getAttribute(indexName));
            thisindex--;
            if (thisindex > -1)
                $("input[" + indexName + "=" + thisindex + "]").focus();
            else {
                 if (indexName == "PartNoIndex")
                    $('#txtPartNoCode').focus();                
            }
        }

    }
</script>
<script>
    function ChkDataDigitCount(e) {

        var data = $(e).val();
        $(e).val(parseFloat(data).toFixed(4));
        if (data == '' || data == null) {
            $(e).val(parseFloat(0).toFixed(4));
        }
    }

    function Scheme_ValueChange() {
        var val = $('#ddlSchema option:selected').val();
        var schemetypeValue = val;
        var schemetype = schemetypeValue.toString().split('~')[1];
        var schemelength = schemetypeValue.toString().split('~')[2];
        var branchID = (schemetypeValue.toString().split('~')[3] != null) ? schemetypeValue.toString().split('~')[3] : "";
        var SchemaID = schemetypeValue.toString().split('~')[0];
        $('#hdnSchemaId').val(SchemaID);
        $('#ddlBankBranch').val(branchID);
        // var fromdate = (schemetypeValue.toString().split('~')[4] != null) ? schemetypeValue.toString().split('~')[4] : "";
        //var todate = (schemetypeValue.toString().split('~')[5] != null) ? schemetypeValue.toString().split('~')[5] : "";
        document.getElementById("OrderNo").maxLength = schemelength;
        if (schemetype == '0') {
            $('#OrderNo').removeAttr("disabled");
            $('#OrderNo').val('');

            $('#OrderNo').focus();
        }
        else if (schemetype == '1') {
            $('#OrderNo').attr("disabled", "disabled");
            $('#OrderNo').val('Auto');

            //$('#OrderNo').focus();

        }
        else if (schemetype == '2') {
            $('#OrderNo').attr("disabled", "disabled");
            $('#OrderNo').val('Datewise');

            //$('#OrderNo').focus();

        }
        else if (schemetype == 'n') {
            $('#OrderNo').attr("disabled", "disabled");
            $('#OrderNo').val('');

            //$('#OrderNo').focus();
        }
        else {
            $('#OrderNo').attr("disabled", "disabled");
            $('#OrderNo').val('');

            //$('#OrderNo').focus();

        }

    }

    function PopulateNumberingSchemeData() {
        $.ajax({
            type: "POST",
            url: "@Url.Action("getNumberingSchemeRecord", "WorkOrder")",
            success: function (response) {
                var html = "";
                var hdnOrder_SchemaID = $('#hdnOrder_SchemaID').val();

                for (var i = 0; i < response.length; i++) {
                    if (hdnOrder_SchemaID != '' && hdnOrder_SchemaID>0) {
                        html = html + "<option value='" + response[i].SchemaID + "' selected>" + response[i].SchemaName + "</option>";
                    }
                    else {
                        html = html + "<option value='" + response[i].SchemaID + "'>" + response[i].SchemaName + "</option>";
                    }
                }
                $('#ddlSchema').html(html);
                $('#ddlSchema').focus();
            }
        });
    }

    var globalindexcheck = 0;
    var globalindexcheck2 = 0;
    var cpSelectedKeys = "";
    var cpSelectedKeys2 = "";

    function WorkCenterSelectionChanged(s, e) {
       
        $('#lblWorkCenterName').text('');
        if (e.isChangedOnServer) return;
        globalindexcheck2 = WorkCenterGridLookup.gridView.focusedRowIndex;
        var key = WorkCenterGridLookup.gridView.GetRowKey(globalindexcheck2)

        if (key != null && globalindexcheck2 > -1) {

            cpSelectedKeys2 = "";
            var WorkCenterName = WorkCenterGridLookup.gridView.GetRow(globalindexcheck2).children[1].innerHTML;
            var WorkCenterDesc = WorkCenterGridLookup.gridView.GetRow(globalindexcheck2).children[2].innerHTML;

            $('#WorkCenterID').val(key);
            cpSelectedKeys2 = key;
            WorkCenterGridLookup.SetTextWithoutApply(WorkCenterName);
            $('#lblWorkCenterName').text(WorkCenterDesc);
        }
        else {
            cpSelectedKeys2 = "";
            $('#WorkCenterID').val(0);
            $('#lblWorkCenterName').text('');
        }
    }

    function ProductionOrderSelectionChanged(s, e) {

        if (e.isChangedOnServer) return;
        globalindexcheck = ProductionOrderGridLookup.gridView.focusedRowIndex;
        var key = ProductionOrderGridLookup.gridView.GetRowKey(globalindexcheck)
        if (key != null && globalindexcheck > -1) {
            cpSelectedKeys = "";
            cpSelectedKeys = key;

            var ProductionOrderno = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[1].innerHTML;
            var bomno = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[2].innerHTML;
            var revno = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[3].innerHTML;

            var productitem = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[5].innerHTML;
            var finisheduom = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[6].innerHTML;
            var productqty = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[7].innerHTML;

             var unit = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[8].innerHTML;
            var warehouse = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[9].innerHTML;

            cpSelectedKeys = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[11].innerHTML;

            POdate = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[12].innerHTML;

            var BalQty = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[13].innerHTML;

            var ActualAdditionalCost = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[14].innerHTML;
            if (ActualAdditionalCost == "&nbsp;" || ActualAdditionalCost == undefined) {
                ActualAdditionalCost = "";
            }
            $('#txtActualAdditionalCost').val(ActualAdditionalCost);
            var TotalResourceCost = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[15].innerHTML;
            if (TotalResourceCost == "&nbsp;" || TotalResourceCost == undefined) {
                TotalResourceCost = "";
            }
            $('#txtTotalResourceCost').val(TotalResourceCost);

            var fromdate = new Date(POdate.replace(/(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3"));
            OrderDate_dt.SetMinDate(fromdate);
            if (OrderDate_dt.GetValue() < new Date(fromdate)) {
                OrderDate_dt.SetDate(new Date(fromdate));
            }

            if (revno == "&nbsp;" || revno == undefined) {
                revno = "";
            }
            $('#BOMNo').val(bomno);
            $('#RevNo').val(revno);
            $('#FinishedItem').val(productitem);
            $('#FinishedUom').val(finisheduom);
            $('#hdnProductQty').val(parseFloat(productqty).toFixed(4));

            $('#hdnBalQty').val(parseFloat(BalQty).toFixed(4));
            $('#txtProductionOrderQty').val(parseFloat(productqty).toFixed(4));
            $('#Order_Qty').val(parseFloat(BalQty).toFixed(4));
            $('#BRANCH_ID').val(unit);
            $('#Warehouse').val(warehouse);
            $('#Production_ID').val(key);
            OrderDate_dt.SetFocus();

            
            var PartNo = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[16].innerHTML;
            var PartNoName = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[17].innerHTML;
            var ItemRev_No = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[18].innerHTML;
            var DEsign = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[19].innerHTML;
            var Product_Name = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[20].innerHTML;

            var Proj_Code = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[21].innerHTML;
            var Hierarchy = ProductionOrderGridLookup.gridView.GetRow(globalindexcheck).children[22].innerHTML;

            $('#Description').val(Product_Name);
            $('#PartNoName').val(PartNoName);
            $('#DesignNo').val(DEsign);
            $('#ItemRevNo').val(ItemRev_No);
            $('#hdnPartNo').val(PartNo);

            if (Proj_Code == '&nbsp;') {
                $('#Proj_Code').val('');
            }
            else {
                $('#Proj_Code').val(Proj_Code);
            }

            if (Hierarchy == '&nbsp;') {
                $('#Hierarchy').val('');
            }
            else {
                $('#Hierarchy').val(Hierarchy);
            }

            ProductionOrderGridLookup.SetTextWithoutApply(ProductionOrderno);

        }
        else {
            cpSelectedKeys = "";
            $('#BOMNo').val('');
            $('#RevNo').val('');
            $('#FinishedItem').val('');
            $('#FinishedUom').val('');
            $('#Production_ID').val(0);
            $('#hdnProductQty').val(parseFloat(0).toFixed(4));
            $('#hdnBalQty').val(parseFloat(0).toFixed(4));
            $('#Order_Qty').val(parseFloat(0).toFixed(4));

            $('#Description').val('');
            $('#PartNoName').val('');
            $('#DesignNo').val('');
            $('#ItemRevNo').val('');
            $('#hdnPartNo').val('');

            $('#Proj_Code').val('');
            $('#Hierarchy').val('');

        }
        populateWOBOMProductList();
    }

    function populateWOBOMProductList() {
        if (cpSelectedKeys > 0 && cpSelectedKeys != "" && cpSelectedKeys != null) {
            var production_id = $('#Production_ID').val()
            $.ajax({
                type: "POST",
                url: "@Url.Action("SetTempID", "WorkOrder")",
                data: { DetailsID: cpSelectedKeys, Production_ID: production_id },
                success: function (response) {
                    if (response) {
                        gridProductionBOMProductList.Refresh();
                    }
                }
            });
        }
    }
    $(document).ready( function(){
        if ('@ViewBag.ProjectShow' == "Yes") {
        $("#divProj").removeClass("hidden");
        }
        else {
                $("#divProj").addClass("hidden");
        }

        if ('@ViewBag.Hierarchy' == "1") {
            $('#divHierarchy').removeClass('hidden');
        }
        else {
            $('#divHierarchy').addClass('hidden');
        }
    });

    $(function () {


        PopulateNumberingSchemeData();
        ChkDataDigitCount($('#Order_Qty'));

        var lookup = ASPxClientControl.GetControlCollection().GetByName("ProductionOrderGridLookup");
        lookup.GetGridView().Refresh();
        lookup.GetGridView().Refresh();

        var lookup2 = ASPxClientControl.GetControlCollection().GetByName("WorkCenterGridLookup");
        lookup2.GetGridView().Refresh();
        lookup2.GetGridView().Refresh();


        $(".decimalCheck").on("keypress keyup blur", function (event) {
            //this.value = this.value.replace(/[^0-9\.]/g,'');
            $(this).val($(this).val().replace(/[^0-9\.]/g, ''));
            if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
                event.preventDefault();
            }
        });


        $("body").bind("keydown", function (event) {
            if (event.keyCode == 88 && event.altKey == true) { //  && myModal.GetVisible() == true

                if ($('#hdnViewMode').val() != 1)
                {
                    WorkOrderSave('Exit');
                }

            }
            if (event.keyCode == 83 && event.altKey == true) { //  && myModal.GetVisible() == true
                if ($('#hdnViewMode').val() != 1) {
                    WorkOrderSave('New');
                }
            }
        });
        PopulateDataInEditMode();
    });

    function ProductionOrderGotFocus(s, e) {
        ProductionOrderGridLookup.ShowDropDownArea();
    }

    function WorkCenterGotFocus(s, e) {
        WorkCenterGridLookup.ShowDropDownArea();
    }

    function PopulateDataInEditMode() {
        
        var WorkOrderID = $('#WorkOrderID').val();
        if (WorkOrderID > 0) {
            var order_schemaid = $('#Order_SchemaID').val();
            $('#hdnSchemaId').val(order_schemaid);
            //$('#ddlSchema').val(order_schemaid);
            $('#ddlSchema').attr("disabled", "disabled");
            OrderDate_dt.SetEnabled(false);
            $('#btnSaveAndNew').hide();
            $('#Order_Qty').focus();
            $('#Order_Qty').select();
            var ProductionOrderNo = $('#ProductionOrderNo').val();
            var Production_ID = $('#Production_ID').val();

            ProductionOrderGridLookup.SetEnabled(false);
            ProductionOrderGridLookup.SetValue(Production_ID);
            ProductionOrderGridLookup.SetTextWithoutApply(ProductionOrderNo);

            var WorkCenterCode = $('#WorkCenterCode').val();
            var WorkCenterID = $('#WorkCenterID').val();

            var WorkCenterDesc = $('#WorkCenterDescription').val();

            $('#lblWorkCenterName').text(WorkCenterDesc);
          
            WorkCenterGridLookup.SetEnabled(false);           
            WorkCenterGridLookup.SetValue(WorkCenterID);
            WorkCenterGridLookup.SetTextWithoutApply(WorkCenterCode);
           
            var TotalAm = $('#hdnBOMEntryProductsTotalAm').val();
            $('#txtGridProductEntryTotalAmount').val(TotalAm);

        }
        else {
            $('#WorkOrderID').val(0);
            $('#btnSaveAndNew').show();
            //$("#BOMNo").removeAttr("disabled");
            $("#ddlSchema").removeAttr("disabled");
            $('#lblWorkCenterName').text('');
            //$("#slcbomtype").removeAttr("disabled");
            $('#FinishedQty').removeAttr("disabled");
            //$('#ddlBankBranch').removeAttr("disabled");
            $('#ddlWarehouse').removeAttr("disabled");
            OrderDate_dt.SetEnabled(true);
            ProductionOrderGridLookup.SetEnabled(true);
            WorkCenterGridLookup.SetEnabled(true);
            //RevisionDate_dt.SetEnabled(true);
            $('#Order_Qty').val(parseFloat(0).toFixed(4));
            $('#ddlSchema').focus();
        }
    }

    var globalrowindex = 0;
    var Message = "";
    function gridclick(s, e) {
        globalrowindex = e.visibleIndex;
    }

    function WOBOMProductEndCallBack(s, e) {
        //debugger;
        var TotalAm = $('#hdnBOMEntryProductsTotalAm').val();
        $('#txtGridProductEntryTotalAmount').val(TotalAm);
    }

    function GetServerDateFormat(today) {
        if (today != "" && today != null) {
            var dd = today.getDate();
            var mm = today.getMonth() + 1;
            var yyyy = today.getFullYear();

            if (dd < 10) {
                dd = '0' + dd;
            }
            if (mm < 10) {
                mm = '0' + mm;
            }
            today = yyyy + '-' + mm + '-' + dd;
        }
        else {
            today = "";
        }

        return today;
    }

    function BOMGridSetAmount(s, e) {

        gridProductionBOMProductList.batchEditApi.EndEdit();
        gridProductionBOMProductList.batchEditApi.StartEdit();
        var Price = gridProductionBOMProductList.batchEditApi.GetCellValue(globalrowindex, 'Price');
        var Qty = gridProductionBOMProductList.batchEditApi.GetCellValue(globalrowindex, 'ProductQty');
        if (Price != "" && Qty != "") {
            var amount = parseFloat((parseFloat(Qty).toFixed(4)) * (parseFloat(Price).toFixed(2))).toFixed(2);

            gridProductionBOMProductList.batchEditApi.StartEdit(globalrowindex, 9);
            gridProductionBOMProductList.GetEditor('Amount').SetText(amount);
            BOMGridSetTotalAmount("", "");
        }
    }

    function BOMGridSetTotalAmount(s, e) {
        //debugger;
        gridProductionBOMProductList.batchEditApi.EndEdit();
        gridProductionBOMProductList.batchEditApi.StartEdit();
        var ToTalAmount = $('#txtGridProductEntryTotalAmount').val();

        var Amountval = gridProductionBOMProductList.batchEditApi.GetCellValue(globalrowindex, 'Amount');
        if (ToTalAmount != "" || ToTalAmount != undefined || ToTalAmount != null) {
            ToTalAmount = parseFloat(0).toFixed(2);
        }
        if (Amountval != "" && Amountval != null && Amountval != undefined) {
            ToTalAmount = parseFloat(0).toFixed(2);
            var calTotalAmount = parseFloat(parseFloat(ToTalAmount) + parseFloat(Amountval)).toFixed(2);
            $('#txtGridProductEntryTotalAmount').val(calTotalAmount);
        }

    }

    function OnStartCallback(s, e) {
        //debugger;
        var orderno = $('#OrderNo').val();
        var OrderDate = GetServerDateFormat(OrderDate_dt.GetValue());
        var Production_ID = $('#Production_ID').val();
        var WorkCenterID = $('#WorkCenterID').val();
        var WorkOrderID = $('#WorkOrderID').val();

        var ProductionOrderID = Production_ID;
        //var WorkCenterID = cpSelectedKeys2;

        var hdnProductionOrderID = $('#hdnProductionOrderID').val();

        var Order_Qty = $('#Order_Qty').val();
        var Unit = $('#ddlBankBranch option:selected').val();
        var order_schemaid = $('#hdnSchemaId').val();
        var ActualAdditionalCost = $('#txtActualAdditionalCost').val();
        if (ActualAdditionalCost == '') {
            ActualAdditionalCost = parseFloat(0).toFixed(2);
            $('#txtActualAdditionalCost').val(ActualAdditionalCost);
        }
        var TotalCost = $('#txtGridProductEntryTotalAmount').val();

        var strRemarks = $('#strRemarks').val();
        var PartNO = $('#hdnPartNo').val();
        if (e != undefined) {
            e.customArgs["ProductionOrderID"] = hdnProductionOrderID;
            e.customArgs["WorkOrderID"] = WorkOrderID;
            e.customArgs["OrderNo"] = orderno;
            e.customArgs["Order_SchemaID"] = order_schemaid;
            e.customArgs["OrderDate"] = OrderDate;

            e.customArgs["Order_Qty"] = Order_Qty; //EmployeesCounterTargetList

            e.customArgs["ActualAdditionalCost"] = ActualAdditionalCost;
            e.customArgs["TotalCost"] = TotalCost;
            e.customArgs["Production_ID"] = ProductionOrderID;
            e.customArgs["WorkCenterID"] = WorkCenterID;
            e.customArgs["BRANCH_ID"] = Unit;
            e.customArgs["strRemarks"] = strRemarks;
            e.customArgs["PartNo"] = PartNO;
        }



    }

    function OnEndCallback(s, e) {
        //debugger;

        var TotalAm = $('#hdnBOMEntryProductsTotalAm').val();
        $('#txtGridProductEntryTotalAmount').val(TotalAm);

        var orderno = s.cpOrderNo;
        Message = s.cpMessage;
        if (s.cpBatchUpdate == "1") {

            s.cpBatchUpdate = "0";

            $('#OrderNo').val('');
            $('#strRemarks').val('');
            //var BOMDate = GetServerDateFormat(BOMDate_dt.GetValue());
            //var BOMDate = $('#BOMDate_dt').val();
            $('#Production_ID').val(0);
            $('#WorkCenterID').val(0);
            $('#hdnDetails_ID').val(0);
            $('#Order_Qty').val(parseFloat(0).toFixed(4));
            $('#hdnSchemaId').val('');
            $('#hdnProductionOrderID').val(0);

            //$('#ddlBankBranch option:selected').val($("#ddlBankBranch option:first").val());
            //$('#ddlWarehouse option:selected').val($("#ddlWarehouse option:first").val());
            $('#ddlSchema').val($("#ddlSchema option:first").val());
            $('#ddlBankBranch').val($("#Unit option:first").val());
            $('#Warehouse').val('');
            cpSelectedKeys = "";
            cpSelectedKeys2 = "";
            $('#txtActualAdditionalCost').val(parseFloat(0).toFixed(4));
            $('#txtGridProductEntryTotalAmount').val(parseFloat(0).toFixed(2));
            $('#txtGridResourcesTotalAmount').val(parseFloat(0).toFixed(2));
            WorkCenterGridLookup.gridView.UnselectAllRowsOnPage();
            ProductionOrderGridLookup.gridView.UnselectAllRowsOnPage();
            $('#RevNo').val('');
            $('#FinishedItem').val('');
            $('#FinishedUom').val('');
            ProductionOrderGridLookup.OnClear();
            WorkCenterGridLookup.OnClear();
            gridProductionBOMProductList.Refresh();
            gridProductionBOMProductList.Refresh();

            if (orderno != "" && orderno != null) {

                jAlert('Order Number : ' + orderno + ' Successfully saved.', 'Alert!', function (r) {
                    if (r) {
                        if (savemode == "Exit") {
                            setTimeout(function () {
                                var url = $('#hdnWorkOrderListPage').val();
                                window.location.href = url;
                            }, 500);
                        }
                    }

                });
            }
            else {
                savemode = "";
                jAlert('Please try again later.');
                return false;
            }

        }

        if (Message == "duplicate") {
            jAlert('This Order no already present!');

            return false;
        }
        //else {
        //AddNewRowWithSl();
        //$('#txtGridProductEntryTotalAmount').val(parseFloat(0).toFixed(2));
        //if (Message == "duplicate" && hasmsg == 0) {
        //    jAlert('This BOM no already present!');
        //    hasmsg = 1;
        //    return false;
        //}
        ////else {
        ////    jAlert('Please try again later.');
        ////    return false;
        ////}
        ////}

    }

    function ChkMoneyDigitCount(e) {
        var data = $(e).val();
        $(e).val(parseFloat(data).toFixed(2));
    }


    function totalAmountSetLogic() {
        //Logic For Set Total Amount 24-05-2019
        var caltotalamount = 0;
        gridProductionBOMProductList.batchEditApi.EndEdit();
        for (var i = 500; i > -500; i--) {
            if (gridProductionBOMProductList.GetRow(i)) {
                var Amountval = gridProductionBOMProductList.batchEditApi.GetCellValue(i, 'Amount');
                if (Amountval != null && Amountval != "") {
                    caltotalamount = caltotalamount + parseFloat(Amountval);
                }
            }
            $('#txtGridProductEntryTotalAmount').val(caltotalamount);
        }

        //Logic For Set Total Amount 24-05-2019
    }

    function changeQtyValue(e) {

        var newqty = $(e).val();
        var hdnproductqty = $('#hdnProductQty').val();
        var visiablerow = gridProductionBOMProductList.GetVisibleRowsOnPage();
        if (visiablerow > 0) {
            for (var i = 500; i > -500; i--) {
                if (gridProductionBOMProductList.GetRow(i)) {
                    gridProductionBOMProductList.batchEditApi.StartEdit(i, 3);
                    var Qty = 0;

                    //if ($('#WorkOrderID').val() > 0) {
                    Qty = gridProductionBOMProductList.batchEditApi.GetCellValue(i, 'OLDQty');
                    //}
                    //else {
                    //    Qty = gridProductionBOMProductList.batchEditApi.GetCellValue(i, 'ProductQty');
                    //}
                    if (parseFloat(Qty) > 0) {
                        var calcqty = (parseFloat(Qty) * newqty) / hdnproductqty;
                        gridProductionBOMProductList.GetEditor('ProductQty').SetText(parseFloat(calcqty).toFixed(4));
                        globalrowindex = i;
                        BOMGridSetAmount("", "");
                    }
                }
            }
            totalAmountSetLogic();
        }
    }

    function setUpdateEditVlaueToGrid() {
        var visiablerow = gridProductionBOMProductList.GetVisibleRowsOnPage();
        if (visiablerow > 0) {
            for (var i = 0; i < 1000; i++) {
                if (gridProductionBOMProductList.GetRow(i)) {
                    if (gridProductionBOMProductList.GetRow(i).style.display != "none") {
                        gridProductionBOMProductList.batchEditApi.StartEdit(i, 12);
                        gridProductionBOMProductList.GetEditor("UpdateEdit").SetText(gridProductionBOMProductList.GetEditor("UpdateEdit").GetText() + i);
                    }
                }
            }

            for (i = -1; i > -1000; i--) {
                if (gridProductionBOMProductList.GetRow(i)) {
                    if (gridProductionBOMProductList.GetRow(i).style.display != "none") {
                        gridProductionBOMProductList.batchEditApi.StartEdit(i, 12);
                        gridProductionBOMProductList.GetEditor("UpdateEdit").SetText(gridProductionBOMProductList.GetEditor("UpdateEdit").GetText() + i);
                    }
                }
            }
        }
    }

    function SuffleRows() {

        for (var i = 0; i < 1000; i++) {
            if (gridProductionBOMProductList.GetRow(i)) {
                if (gridProductionBOMProductList.GetRow(i).style.display != "none") {
                    gridProductionBOMProductList.batchEditApi.StartEdit(i, 14);
                    gridProductionBOMProductList.GetEditor("UpdateEdit").SetText(gridProductionBOMProductList.GetEditor("UpdateEdit").GetText() + i);
                }
            }
        }

        for (i = -1; i > -1000; i--) {
            if (gridProductionBOMProductList.GetRow(i)) {
                if (gridProductionBOMProductList.GetRow(i).style.display != "none") {
                    gridProductionBOMProductList.batchEditApi.StartEdit(i, 14);
                    gridProductionBOMProductList.GetEditor("UpdateEdit").SetText(gridProductionBOMProductList.GetEditor("UpdateEdit").GetText() + i);
                }
            }
        }
    }

    var savemode = "";
    var hasmsg = 0;

    function WorkOrderSave(mode) {
        setUpdateEditVlaueToGrid();
        savemode = mode;
        hasmsg = 0;

        var WorkOrderID = $('#WorkOrderID').val()
        var orderno = $('#OrderNo').val();
        var OrderDate = GetServerDateFormat(OrderDate_dt.GetValue());
        var Production_ID = $('#Production_ID').val();
        //var Details_ID = $('#hdnDetails_ID').val();
        var Unit = $('#ddlBankBranch option:selected').val();
        var Order_Qty = $('#Order_Qty').val();
        var workcenter = $('#WorkCenterID').val();//WorkCenterGridLookup.gridView.currentSelectionState.InputText;

        var hdnBalQty = $('#hdnBalQty').val();

        var order_schemaid = $('#hdnSchemaId').val();
        var ActualAdditionalCost = $('#txtActualAdditionalCost').val();
        if (ActualAdditionalCost == '') {
            ActualAdditionalCost = parseFloat(0).toFixed(2);
            $('#txtActualAdditionalCost').val(ActualAdditionalCost);
        }
        var ddlSchema = $('#ddlSchema option:selected').val();
        var TotalCost = $('#txtGridProductEntryTotalAmount').val();
        SuffleRows();
        var visiablerow = gridProductionBOMProductList.GetVisibleRowsOnPage();
        if (visiablerow > 0) {
            if (orderno != '' && OrderDate != '' && Order_Qty != '' && workcenter > 0 && Production_ID > 0 && ActualAdditionalCost != '' && Unit != undefined) {

                if (parseFloat(hdnBalQty) < parseFloat(Order_Qty) && WorkOrderID < 1) {
                    $('#Order_Qty').focus();
                    $('#Order_Qty').select();
                    jAlert('Order Qty entered is greater than available quantity. Cannot proceed.');

                    return false;
                }
                else {

                    var msgbalqty = '';
                    var msgbalqtyindex = 0;
                    for (var i = 0; i < visiablerow; i++) {
                        if (gridProductionBOMProductList.GetRow(i)) {
                            //gridProductionBOMProductList.batchEditApi.StartEdit(i, 3);
                            var Qty = gridProductionBOMProductList.batchEditApi.GetCellValue(i, 'ProductQty');
                            var balQty = gridProductionBOMProductList.batchEditApi.GetCellValue(i, 'BalQty');
                            if (parseFloat(Qty) > parseFloat(balQty)) {
                                msgbalqty = 'Qty entered is greater than available quantity. Cannot proceed.';
                                msgbalqtyindex = i;
                            }
                        }
                    }
                    if (msgbalqty == '') {

                        gridProductionBOMProductList.UpdateEdit();
                        gridProductionBOMProductList.UpdateEdit();
                        $('#EddlSchema').hide();
                        $('#EOrderNo').hide();
                        $('#EOrderDate_dt').hide();
                        $('#Eworkcenter').hide();
                    }
                    else {
                        //gridProductionBOMProductList.batchEditApi.EndEdit();
                        setTimeout(function () {
                            gridProductionBOMProductList.batchEditApi.StartEdit(msgbalqtyindex, 3);
                        }, 800);

                        jAlert(msgbalqty);

                        return false;
                    }
                }
            }
            else {
                savemode = "";
                if (ddlSchema == '') {
                    $('#EddlSchema').show();
                }
                else {
                    $('#EddlSchema').hide();
                }
                if (orderno == '') {
                    $('#EOrderNo').show();
                }
                else {
                    $('#EOrderNo').hide();
                }
                if (OrderDate == '') {
                    $('#EOrderDate_dt').show();
                }
                else {
                    $('#EOrderDate_dt').hide();
                }
                if (workcenter > 0) {
                    $('#Eworkcenter').hide();
                }
                else {
                    $('#Eworkcenter').show();
                }
                if (Unit == undefined || Unit == "") {
                    $('#Eunit').show();
                }
                else {
                    $('#Eunit').hide();
                }

                return false;
            }
        }
        else {
            jAlert('Please select Production who has products!');
            return false;
        }
    }

    function SetDefaultDate(s, e) {
        OrderDate_dt.SetValue(new Date());
    }

</script>



<div class="panel-title clearfix" id="myDiv">
    <h3 class="pull-left">
        <label>Work Order(Production)</label>
    </h3>
    <div id="ApprovalCross" class="crossBtn"><a href="@Url.Action("WorkOrderList", "WorkOrder")"><i class="fa fa-times"></i></a></div>
</div>

<input type="hidden" value="0" id="hdnSchemaId" />
@Html.HiddenFor(x => x.WorkOrderID)
@Html.HiddenFor(x => x.Production_ID)
@Html.HiddenFor(x => x.WorkCenterID)
@Html.HiddenFor(x => x.Order_SchemaID, new { @id = "hdnOrder_SchemaID" })
@Html.HiddenFor(x => x.ProductionOrderNo)
@Html.HiddenFor(x => x.WorkCenterCode)
<input type="hidden" value="@Model.PartNo" id="hdnPartNo" />
@Html.HiddenFor(x => x.WorkCenterDescription)

<input type="hidden" id="hdnBalQty" value="0" />
@Html.HiddenFor(x => x.Finished_Qty, new { @id = "hdnProductQty" })
@*<input type="hidden" value="@Model.Finished_Qty" id="" />*@
<input type="hidden" value="@Url.Action("WorkOrderList", "WorkOrder")" id="hdnWorkOrderListPage" />
<input type="hidden" value="@ViewBag.IsView" id="hdnViewMode" />

<div class="boxBorder">
    <div class="styledBox">
        <div class="row">
            <div class="col-md-2">
                <label>Numbering Scheme <span style="color:red">*</span></label>
                <div class="relative">
                    <select id="ddlSchema" class="form-control" onchange="Scheme_ValueChange()"></select>
                    <span id="EddlSchema" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>
            @*<div class="col-sm-2">
                    <label>BOM Type <span style="color:red">*</span></label>
                    <select id="slcbomtype" class="form-control">
                        <option value="Production">Production</option>
                        <option value="Sales">Sales</option>
                        <option value="Assembly">Assembly</option>
                    </select>
                </div>*@

            <div class=" col-sm-2">
                <label>Work Order No. <span style="color:red">*</span></label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.OrderNo, new { @class = "form-control", @disabled = "disabled" })
                    <span id="EOrderNo" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>

            <div class=" col-sm-2">
                <label>Work Order Date <span style="color:red">*</span></label>
                <div class="relative">
                    @Html.DevExpress().DateEdit(
                                     settings =>
                                     {
                                         settings.Name = "OrderDate_dt";
                                         settings.Properties.DisplayFormatString = "dd-MM-yyyy";
                                         settings.Properties.EditFormatString = "dd-MM-yyyy";
                                         settings.Width = Unit.Percentage(100);
                                         //settings.Properties.ClientSideEvents.DateChanged = "datevalidateTo";
                                         settings.Date = Convert.ToDateTime(@Model.dtOrderDate);
                                         settings.Properties.ClientSideEvents.Init = "SetDefaultDate";
                                         settings.Properties.UseMaskBehavior = true;
                                     }
                            ).GetHtml()
                    <span id="EOrderDate_dt" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>

            <div class=" col-sm-2">
                <label>Production Order No. <span style="color:red">*</span></label>
                <div class="relative">
                    @*@Html.TextBoxFor(m => m.BOMNo, new { @class = "form-control", @disabled = "disabled" })
                        <span id="EBOMNo" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>*@
                    <div class="lookupTdHide">
                        @Html.Action("GetPOList", "WorkOrder")
                    </div>
                </div>
            </div>



            <div class=" col-sm-2">
                <label>BOM No. <span style="color:red">*</span></label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.BOMNo, new { @class = "form-control", @disabled = "disabled" })
                    <span id="EBOMNo" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>

            <div class=" col-sm-2">
                <label>Revision No. <span style="color:red">*</span></label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.RevNo, new { @class = "form-control", @disabled = "disabled" })
                    <span id="ERevNo" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>



        </div>
        <div class="row">
            <div class=" col-sm-2">
                <label class="mtop10">Finished Item </label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.FinishedItem, new { @class = "form-control", @disabled = "disabled" })
                </div>
            </div>
            <div class="col-sm-2">
                <label class="mtop10">Order Qty <span style="color:red">*</span></label>

                <div class="relative">

                    <table style="width:100%" class="finishedQttable">
                        <tr>
                            <td>@Html.TextBoxFor(m => m.Order_Qty, new { @class = "form-control decimalCheck", @onchange = "ChkDataDigitCount(this); changeQtyValue(this);", @PlaceHolder = "0.0000" })</td>
                            <td>@Html.TextBoxFor(m => m.FinishedUom, new { @class = "form-control", @disabled = "disabled" })</td>
                        </tr>
                    </table>
                    <span id="EFinishedQty" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>
            <div class=" col-sm-2">
                <label class="mtop10">Unit <span style="color:red">*</span></label>
                <div class="relative">
                    @Html.DropDownListFor(x => x.BRANCH_ID, new SelectList(Model.UnitList, "BranchID", "BankBranchName"), new { @id = "ddlBankBranch", @class = "form-control", @disabled = "disabled", @onchange = "PopulateWareHouseData();" })
                    @*@Html.TextBoxFor(m => m.Unit, new { @class = "form-control", @disabled = "disabled" })*@

                    <span id="Eunit" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
                @*@Html.TextBoxFor(m => m.Unit, new { @class = "form-control" })*@
            </div>
            <div class=" col-sm-2">
                <label class="mtop10">Warehouse </label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.Warehouse, new { @class = "form-control", @disabled = "disabled" })
                </div>
            </div>

            <div class=" col-sm-2">
                <label class="mtop10">Work Center <span style="color:red">*</span></label>
                <div class="relative">
                    <div class="lookupTdHide">
                        @Html.Action("GetWCList", "WorkOrder")
                    </div>
                    <span id="Eworkcenter" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>
                </div>
            </div>

            <div class=" col-sm-2">
                <label class="mtop10">Work Center Name</label>
                <div class="relative">
                    <label id="lblWorkCenterName" style="width: 100%; background: #fff; height: 24px; border: 1px solid #ccc; padding: 3px 5px;"></label>
                </div>
            </div>
        </div>

        <div class="row">
            <div class=" col-sm-2">
                <label class="mtop10">Remarks </label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.strRemarks, new { @class = "form-control" })
                </div>
            </div>
            <div class=" col-sm-3">
                <label class="mtop10">Description</label>
                @Html.TextBoxFor(m => m.Description, new { @class = "form-control", @disabled = "disabled" })
            </div>
            <div class=" col-sm-2">
                <label class="mtop10">Part No:</label>
                <div class="relative">
                    @Html.TextBoxFor(m => m.PartNoName, new { @class = "form-control", @disabled = "disabled" })
                    @*@Html.DevExpress().ButtonEdit(
                         settings =>
                         {
                             settings.Name = "btnPartNo";
                             settings.Width = System.Web.UI.WebControls.Unit.Percentage(100);
                             settings.Text = Model.PartNoName;
                             settings.ReadOnly = true;
                             settings.Properties.Buttons.Add("...");
                             settings.Properties.ClientSideEvents.ButtonClick = "function(s,e){btnPartNoList_Click(s,e);}";
                             settings.Properties.ClientSideEvents.KeyDown = "function(s,e){btnPartNo_KeyDown(s,e);}";
                         }).GetHtml()*@
                    @*<span id="EbtnFinishedItem" class="customerno pullleftClass fa fa-exclamation-circle iconRed " style="color: red; position: absolute; display: none" title="Mandatory"></span>*@
                </div>

                @*@Html.TextBoxFor(m => m.FinishedItem, new { @class = "form-control" })*@
            </div>
            <div class=" col-sm-2">
                <label class="mtop10">Drawing No:</label>
                @Html.TextBoxFor(m => m.DesignNo, new { @class = "form-control", @disabled = "disabled" })
            </div>
            <div class=" col-sm-2">
                <label class="mtop10">Drawing Rev. No:</label>
                @Html.TextBoxFor(m => m.ItemRevNo, new { @class = "form-control", @disabled = "disabled" })
            </div>
        </div>
        <div class="row">
            <div class=" col-sm-2" id="divProj">
                <label class="mtop10">Project Code:</label>
                @Html.TextBoxFor(m => m.Proj_Code, new { @class = "form-control", @disabled = "disabled" })
            </div>
            <div class=" col-sm-2" id="divHierarchy">
                <label class="mtop10">Hierarchy:</label>
                @Html.TextBoxFor(m => m.Hierarchy, new { @class = "form-control", @disabled = "disabled" })
            </div>
        </div>
    </div>

    <br />

    <div class="row">
        <div class="col-md-12">

            <div id="refreshgrid">
                @{
                    Html.RenderAction("GetWorkOrderDetailsProductList", "WorkOrder", new { DetailsID = Model.Details_ID });
                }
            </div>
            <div class="clearfix footrGrider">
                <div class=" pull-left mTop5" style="margin-left:50%;">
                    <table>
                        <tr>
                            <td class="pdRight10"><label>Total Amount </label></td>
                            <td><input type="text" class="form-control" id="txtGridProductEntryTotalAmount" style=" width: 132px;" placeholder="0.00" disabled /></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>


    </div>


    <div class="clearfix">
        @if (Convert.ToInt16(ViewBag.IsView) == 0)
        {
            <button type="button" class="inline-block addResourceBtn themeColor mRight5" id="btnSaveAndNew" onclick="WorkOrderSave('New');">
                <div class="addEdcircleBtn" id=""><i class="fa fa-floppy-o"></i></div>
                <span><u>S</u>ave and New</span>


            </button>
            <button type="button" class="inline-block addResourceBtn themeColor " onclick="WorkOrderSave('Exit');">
                <div class="addEdcircleBtn" id=""><i class="fa fa-reply"></i></div>
                <span>Save and E<u>x</u>it</span>
            </button>
        }
        <div class="inline-block pull-right">
            <div class="inline-block mTop5">
                <label class="stLbl "> Additional Cost</label>
                <div><input type="text" value="@Model.ActualAdditionalCost" placeholder="0.00" id="txtActualAdditionalCost" disabled class="form-control decimalCheck" onchange="ChkMoneyDigitCount(this)" /></div>
            </div>
            <div class="inline-block mTop5">
                <label class="stLbl ">Resource Cost</label>
                <div class="disab"><input type="text" value="@Model.TotalResourceCost" placeholder="0.00" class="form-control" id="txtTotalResourceCost" disabled /></div>
            </div>
            <div class="inline-block mTop5">
                <label class="stLbl"> Component Cost</label>
                <div><input type="text" value="@Model.ActualComponentCost" placeholder="0.00" class="form-control" id="txtActualComponentCost" disabled /></div>

            </div>
            <div class="inline-block mTop5">
                <label class="stLbl ">Production Order Qty</label>
                <div><input type="text" value="@Model.ProductionOrderQty" placeholder="0.00" class="form-control" id="txtProductionOrderQty" disabled /></div>

            </div>

            <div class="inline-block mTop5">
                <label class="stLbl ">FG Receipt Qty</label>
                <div><input type="text" value="@Model.FGReceiptQty" placeholder="0.00" class="form-control" id="txtFGReceiptQty" disabled /></div>

            </div>
            <div class="inline-block mTop5">
                <label class="stLbl "> Product Cost</label>
                <div><input type="text" value="@Model.ActualProductCost" placeholder="0.00" class="form-control" id="txtActualProductCost" disabled /></div>

            </div>
        </div>
    </div>

    <div class="row mTop10">

    </div>
    <!-- Product List -->
    <div class="modal fade" id="PartNolistModel" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" onclick="SetFocusItemRevNo();">&times;</button>
                    <h4 class="modal-title">Select Product</h4>
                </div>
                <div class="modal-body">
                    <input type="text" onkeydown="PartNoListkeydown(event)" id="txtPartNoCode" autofocus width="100%" placeholder="Search By Part No." />
                    <div id="PartNoTable">
                        <table border='1' width="100%" class="dynamicPopupTbl">
                            <tbody>
                                <tr class="HeaderStyle">
                                    <th class="hide">id</th>
                                    <th>Product Code</th>
                                    <th>Product Name</th>
                                    <th>Inventory</th>
                                    <th>HSN/SAC</th>
                                    <th>Brand</th>
                                    <th>Class</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="SetFocusItemRevNo();">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Product List-->
</div>